#!groovy
properties([disableConcurrentBuilds()])
//    agent any
//    tools {'maven'}
    pipeline {
        agent {
            label 'master'
        }
        options {
            buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
            timestamps()
        }
        stages {
            stage('Preparation') {
                steps {
                    echo "-=- Cleaning project -=-"
                    sh "./mvnw clean"
                }
            }
            stage('Compile') {
                steps {
                    echo "-=- compiling project -=-"
                    sh "./mvnw compile"
                }
            }
            stage('Testing') {
                steps {
                    echo "-=- Testing -=-"
                    sh "./mvnw test"
                }
            }
            stage('Building project') {
                steps {
                    echo "-=- Build project -=-"
                    sh "./mvnw install -Dmaven.test.skip=true"
                }
            }
            stage('Building docker image') {
                steps {
                    echo "-=- Building docker image -=-"
                    sh 'scp ./target/spring-petclinic-2.2.0.BUILD-SNAPSHOT.jar vagrant@172.18.0.1:~/tmp/spring-petclinic-2.2.0.BUILD-SNAPSHOT:${BUILD_NUMBER}.jar'
                    sh 'scp ./jenkins_file/pet_image.dockerfile vagrant@172.18.0.1:~/tmp/Dockerfile'
                    sh '$BUILD_NUMBER'
                    sh 'ssh vagrant@172.18.0.1:~/tmp \'docker run -v $(pwd):/usr gcr.io/kaniko-project/executor:latest -f Dockerfile -c /usr  -d 172.18.0.2:5000/petclinic:${BUILD_NUMBER}\''
                    //sh 'ssh vagrant@172.18.0.1:~/tmp '


                }
                // agent { dockerfile true
                    //docker {
                    //    image 'gcr.io/kaniko-project/executor:latest'
                      //  args '--dockerfile=/var/jenkins_home/workspace/build-pc/jenkins_file/pet_image.dockerfile \
                        //--destination=172.18.0.2:5000'
                    //}
                //}
            }
        }
    }
